import groovy.xml.MarkupBuilder

apply plugin: 'eclipse'

eclipse {
    classpath {
        plusConfigurations += configurations.cucumberRuntime
    }
    project.file.withXml { 
        addFilteredResources it 
        ignoreSvn it
        ignoreGradleOutputDir it
    }
}
tasks.eclipse.dependsOn(cleanEclipse)

def addFilteredResources (projectRoot) {
    projectRoot.asNode().append new XmlParser().parseText('<filteredResources/>')
}

def addFilter (projectRoot, xml) {
    def filters = projectRoot.node.filteredResources.head()
    filters.append new XmlParser().parseText(xml)
}

def createFilter (filter, matchFor) {
    def writer = new StringWriter()
    def xml = new MarkupBuilder(writer)
    xml.filter() {
        id(new Random().nextInt())
        name()
        type(filter.type)
        matcher {
            id('org.eclipse.ui.ide.multiFilter')
            arguments("1.0-${filter.matcher}-matches-false-false-${matchFor}")
        }
    }
    writer.toString()
}

def ignoreSvn (projectRoot) {
    addFilter(projectRoot, 
        createFilter(type: 26, matcher: 'name', '.svn'))
}

def ignoreGradleOutputDir (projectRoot) {
    addFilter(projectRoot, 
        createFilter(type: 10, matcher: 'projectRelativePath', buildDir.name))
}
